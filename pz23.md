### Поднятие первого контроллера домена на базе Windows Server 2012. Настройка служб AD DS, DNS, DHCP

#### Шаг 1: Установка необходимых компонент

**Подсказка**: зачастую при установке и настройке новых компонент Windows Server, чтобы они начали нормально работать неоходимо перезапустить сервер.

**Подсказка**: проверьте объём оперативной памяти, выделенной для ВМ с Windows Server. Для хостовой ОС должно быть не менее 800 мегабайт, для гостевой Windows не менее 800 мегабайт, для гостевой Windows Server не менее 1700 мегабайт. Сумма этих трёх значений не должна превышать доступной оперативной памяти на хостовой машине.

- Перед запуском мастера ролей, серверу необходимо задать сетевое имя и настроить  статический ip-адрес. Сетевое имя — dc1.
  Настройки TCP/IP укажем как на скриншоте ниже.
    ![image](http://gitlabnto/anetto/wiki/uploads/5d4d0b0cf435e21860a39025140ee466/image.png)
- Запустить диспетчер сервера — **Server Manager -> Dashboard -> Configure this local server -> Add Role and Features Wizard.**
- На первом экране мастер сообщает, что перед тем как продолжить, должен быть установлен сложный пароль администратора, в настройках сети указан статический ip-адрес, установлены  последние обновления. Если все это сделано, то нажимаем Next.
    
    ![image](http://gitlabnto/anetto/wiki/uploads/d91ca07d94477f50e83a76ed3e639ef3/image.png)
- На следующем экране, выбрать первый пункт **Role-based or feature-based installation** (Базовая установка ролей и компонентов). Второй пункт **Remote Desktop Service installtion** предназначен исключительно для установки роли удаленных рабочих столов.

    ![image](http://gitlabnto/anetto/wiki/uploads/5d88a6921eeb9bc8c9c9985b0bd75e64/image.png)
- На экране **Select Destination server** диспетчер предлагает, выбрать сервер из пула или расположенный на VHD-диске. Поскольку у нас пока только один локальный сервер, то нажимаем Next.
    ![image](http://gitlabnto/anetto/wiki/uploads/a385bc291e2b5e51776564699d5ba87c/image.png)
- Выбрать **Active Directory Domain Services** (Доменные службы Active Directory), после чего появится окно с предложением добавить роли и компоненты, необходимые для установки роли AD. Нажать кнопку Add Features и затем Next.
  
    ![image](http://gitlabnto/anetto/wiki/uploads/b5a5a00c6a8f7effbc6d7c5c494ccd4f/image.png)
- Обычно, на серверах с AD DS имеет смысл, параллельно разворачивать DHCP Server, поэтому отметить его для установки так же. Согласиться с установкой компонент. Нажать Next.
  
    ![image](http://gitlabnto/anetto/wiki/uploads/f7dca33800fac83c7fcf766924d2e1e8/image.png)
- На экране **Features** предлагается выбрать дополнительные компоненты. На контроллере домена ничего экстраординарного обычно не требуется, поэтому нажать Next.
  
    ![image](http://gitlabnto/anetto/wiki/uploads/b84bcda7bfd433a080e1a370f74ba05e/image.png)
- На завершающих этапах подготовки к установке, на вкладке AD DS, мастер даст некоторые пояснения, а именно:
  - в случае, если основной контроллер будет не доступен, то рекомендуется в одном домене держать как минимум два контроллера.
  - Службы **Active Directory Domain Services** требуют установленного в сети DNS-сервера. В случае если он не установлен, то роль DNS Server будет предложена для установки.
  - Так же, службы **Active Directory Domain Services** требуют установки дополнительных служб пространства имен, файловой и DFS репликации **(DFS Namespace, DFS Replication, File Replication)**. Нажимаем Next. ![image](http://gitlabnto/anetto/wiki/uploads/264d183fa34f05291d7eb093d6c12e77/image.png)
- На последнем экране **Confirm installation selection** (Подтверждение устанавливаемых компонентов), можно экспортировать конфигурацию в xml-фаил, который поможет быстро установить еще один сервер с идентичными настройками.
- В конце нажать Install. Дождаться окончания процесса
  установки.

    ![image](http://gitlabnto/anetto/wiki/uploads/71f430034709a5a2e20f3d69564e7dbb/image.png)

#### Шаг 2 **Настройка служб Active Directory, DNS, DHCP.**

##### Active Directory, DNS

- Далее нажать на значок треугольника с восклицательным знаком и выбираем сначала **Promote this server to domain
  controller** (Повысить этот сервер до контроллера домена).
  Позже запустим процесс развертывания DHCP-сервера.![1538586112080](http://gitlabnto/anetto/wiki/uploads/aea20b754c3e313043cc902efa7da766/1538586112080.png)

- Запустится мастер **Active Directory Domain Services Configuration Wizard** (Мастер конфигурации доменных служб Active Directory). Доступно, три варианта развертывания, если:

     **Add New Forest** — создать новый корневой домен в новом лесу. Используется для новой «чистой» установки Active Directory; (например 'test.ru')

    **Add a new domain to an existing forest** — добавить новый домен в существующем лесу, возможные варианты: *Tree Domain* -  корневой домен нового дерева в существующем лесу (например 'test2.ru' параллельно с 'test.ru') или *Child Domain* — дочерний домен в существующем лесу (например 'corp.test.ru')

    **Add a domain controller to an existing domain** — добавить дополнительный контроллер домена в существующем домене, используется для резервного или филиального домена.

    Выбрать вариант **Add New Forest**, задать корневое имя домена, нажимать Next.

    **Замечание**: Корневое имя вашего домена должно быть **domain<ваш номер по списку>.local**

    ![1538586272492](http://gitlabnto/anetto/wiki/uploads/62da512e2e93d6d0e431b8bbb940ca23/1538586272492.png)

- На следующей вкладке можно задать функциональный уровень домена и леса (по умолчанию 2012R2), снять или отметить для установки DNS Server, и задать пароль для режима восстановления службы каталогов (DSRM). Укажем только пароль для DSRM и нажать Next.

    ![1538586391441](http://gitlabnto/anetto/wiki/uploads/85fad4f2d263cabd9bdd80982f976d4e/1538586391441.png)

- На следующем шаге **DNS Options** мастер ругнется, на то, что делегирование для этого DNS-сервера создано не было, потому что не найдена дочерняя зона или запущенный DNS-сервер. Что не
  удивительно, т.к. роль DNS Server у нас создается в процессе. Нажать Next.

    ![1538586442563](http://gitlabnto/anetto/wiki/uploads/1d7fdaac5929f71117036440dc1975cd/1538586442563.png)

- Далее в Addional Optional соглаcиться с NetBIOS именем, которое
  предлагает нам система, нажать Next.
 
    ![1538586476700](http://gitlabnto/anetto/wiki/uploads/859d441c68936b3c2cf82fa3f592340b/1538586476700.png)

- В разделе **Paths** можно изменить путь к каталогам баз данных, файлам журнала и к SYSVOL. Оставить по умолчанию, нажать Next.

    ![1538586518414](http://gitlabnto/anetto/wiki/uploads/08b63b742fb7f71e16df1e880c23ccae/1538586518414.png)

- На следующем этапе **Review Options** отображается сводная информация по настройке. Кнопка **View Script**, позволяет посмотреть **Powershell** скрипт, при помощи которого, в будущем можно будет произвести настройку доменных служб **Active Directory**. Нажать Next.

    ![1538586559534](http://gitlabnto/anetto/wiki/uploads/17de21793960bfdf9753d20641762262/1538586559534.png)

- И наконец, на последнем этапе предварительных проверок, если видим надпись: *«All prerequisite checks are passed successfully. Click «install» to begin installation*.» (Все предварительные проверки пройденыуспешно. Нажать кнопку «установить», чтобы начать установку.), то нажимаем Install, дожидаемся окончания процесса установки.

- После перезагрузки, снова зайти в **Server Manager** **->** **Dashboard** и запустить пиктограмму треугольника с восклицательным знаком и выбрать там **Complete DHCP Configuration** (Завершение
  конфигурации DHCP).

    ![1538586676814](http://gitlabnto/anetto/wiki/uploads/f05fa3a3cd93c00e4beb256815bfc061/1538586676814.png)

- Запустится мастер по конфигурированию DHCP, который сообщит, что будут созданы группы безопасности администратора и пользователя DHCP-сервера, и будет произведена авторизация в AD. Нажать Next.![1538586712714](http://gitlabnto/anetto/wiki/uploads/c2e68426975a4bebf73b259031a2e180/1538586712714.png)

- На следующем экране нажать Commit что бы завершить процесс авторизации в Active Directory.

    ![1538586741696](http://gitlabnto/anetto/wiki/uploads/136422d55fd65d6f572f0ee0f2e99fac/1538586741696.png)

- Если видно, что *Create Security Group — Done* и *Authorizing DHCP Server — Done*, то процесс завершился успешно, нажать Close.

- Теперь нужно создать обратную зону в DNS. Обратная зона, позволяет выполнить разрешение FQDN-имен хостов по их IP-адресам. В процессе добавления ролей AD и DNS по умолчанию не создаются, поскольку предполагается, что в сети может существовать другой DNS-сервер, контролирующий обратную зону. Поэтому создадим ее сами, для этого перейти в диспетчер DNS (DNS Manager), на вкладку Reverse Lookup Zones, кликнуть правой кнопкой и выбрать  New Zone.![1538587093550](http://gitlabnto/anetto/wiki/uploads/c04ed9bfd8aeb59e1f91cf009dfffc9d/1538587093550.png)

- Запустится мастер DNS-зоны. Согласиться с параметрами по умолчанию, а именно предлагается создать основную зону которая будет хранится на этом сервере (Primary Zone) и будет интегрирована в Active Directory (Store the zone in Active Directory...). Нажать Next.

    На следующем экране, предлагается выбрать как зона будет реплицироваться, обмениваться данными с другими зонами расположенными на контроллерах и DNS-серверах. Возможны следующие варианты:

    **Для всех DNS-серверов расположенных на контроллере домена в этом лесу (То all DNS servers running on domain controllers in this forest).** Репликации во всем лесу Active Directory включая все деревья доменов.

    **Для всех DNS-серверов расположенных на контроллере домена в этом домене (То all DNS servers running on domain controllers in this domain).** Репликация внутри текущего домена и его дочерних доменов.

    **Для всех контроллеров домена в этом домене (То all domain controllers in this domain).**Репликация на все контроллеры домена внутри текущего домена и его дочерних доменов.

    **На** **все** **контроллеры** **домена** **в** **указанном** **разделе** **каталога** **приложений** **(To all domain controllers specified in the scope of this directory partition).** Репликация на все контроллеры домена, но DNS-зона располагается в специальном каталоге приложений. Поле будет доступно для выбора, после создания каталога.

    ![1538587215806](http://gitlabnto/anetto/wiki/uploads/63bc6dffeb2bfe7b755fa713dde57e8e/1538587215806.png) 

    Выбрать вариант по умолчанию, нажать Next. Затем выбрать протокол по умолчанию IPv4 и снова нажать Next.

- На следующем экране задать идентификатор сети (Network ID). В нашем случае 192.168.0. В поле Reverse Lookup Zone Name видно как автоматически подставится адрес зоны обратного просмотра. Нажать Next.![1538587397159](http://gitlabnto/anetto/wiki/uploads/67ead44cb6002363a53b280785cd3774/1538587397159.png)

- На экране Dynamic Update (динамические обновления), выбрать один из трех возможных вариантов динамического обновления.

    **Разрешить только безопасные динамические обновления (Allow Only Secure Dynamic Updates).** Это опция доступна, только если зона интегрирована в Active Directory.

    **Разрешить любые, безопасные и не безопасные динамические обновления (Allow Both Nonsecure And Secure Dynamic Updates).** Данный переключатель, позволяет любому клиенту обновлять его записи ресурса в DNS при наличии изменений.

    **Запретить динамические обновления** (Do Not Allow Dynamic Updates). Это опция отключает динамические обновления DNS. Ее следует использовать только при отсутствии интеграции зоны с Active Directory.![1538587444985](http://gitlabnto/anetto/wiki/uploads/0f9f1be858874ff85b378c7d693956f0/1538587444985.png)

    Выбрать первый вариант, нажать Next и завершить настройку нажатием Finish.

##### DHCP

- Запустить оснастку DHCP. 

    ![1538587793453](http://gitlabnto/anetto/wiki/uploads/ac531291ac133865363caee24f385094/1538587793453.png)

- Сперва задать полный рабочий диапазон адресов из которого будут браться адреса для выдачи клиентам. Выбрать Action\New Scope. Запустится мастер добавления области. Задать имя области.

    ![1538587822121](http://gitlabnto/anetto/wiki/uploads/0addfeb5beffb26ef58ee3e2ff6dbc8a/1538587822121.png)

- Далее указать начальный и конечный адрес диапазона сети. (**в вашем случае начальный адрес - ваш номер по журналу**) 

    ![1538587841181](http://gitlabnto/anetto/wiki/uploads/d9bd7a6da1370b5cf847883f1043c95b/1538587841181.png)

- Далее добавить адреса которые мы хотим исключить из выдачи клиентам. Нажать Next.

    ![1538591683762](http://gitlabnto/anetto/wiki/uploads/9cd3d084576b15ebbad4478767db2e3e/1538591683762.png)

- На экране Lease Duration указать отличное от по умолчанию время аренды, если требуется. Нажать Next.

- Затем согласиться, что настраивается опция DHCP: Yes, I want to configure these option now.

- Последовательно указать шлюз, доменное имя, адреса DNS, WINS пропустить и в конце согласиться с активацией области нажатием: Yes, I want to activate this scope now. Finish.

    ![1538591809057](http://gitlabnto/anetto/wiki/uploads/e8fe09fb22632968267690f5f876aaa3/1538591809057.png)

    ![1538591829275](http://gitlabnto/anetto/wiki/uploads/233dd83e1d93ff25cc9ddbf3560372bd/1538591829275.png)

    ![1538591835742](http://gitlabnto/anetto/wiki/uploads/dec17c79e04c3eda702903d74f5b63da/1538591835742.png)

- Для безопасной работы службы DHCP, требуется настроить специальную учетную запись для динамического обновления записей DNS. Это необходимо сделать, с одной стороны для того что бы предотвратить динамическую регистрацию клиентов в DNS при помощи административной учетной записи домена и возможного злоупотребления ею, с другой стороны в случае резервирования службы DHCP и сбоя основного сервера, можно будет перенести резервную копию зоны на второй сервер,
  а для этого потребуется учетная запись первого сервера. Для выполнения этих условий, в оснастке Active Directory Users and Computers создать учетную запись с именем dhcp и назначим бессрочный пароль, выбрав параметр: Password Never Expires.

    ![1538591978905](http://gitlabnto/anetto/wiki/uploads/6c1248c304478f4fa29f78e792ecdf32/1538591978905.png)
- Назначить пользователю надежный пароль и добавить в группу DnsUpdateProxy. Затем удалим пользователя из группы Domain Users, предварительно назначив пользователю primary группу «DnsUpdateProxy». Данная учетная запись будет отвечать исключительно за динамическое обновление записей и не иметь доступа не каким другим ресурсам где достаточно базовых доменных прав.

    ![1538592019887](http://gitlabnto/anetto/wiki/uploads/f45fce6e49879ea2a79e4fd9368d4eba/1538592019887.png)
- Нажать Apply и затем ОК. Открываем снова консоль DHCP.
- Перейти в свойства протокола IPv4 на вкладку Advanced.

    ![1538592068094](http://gitlabnto/anetto/wiki/uploads/2934aa825405042f5e743e2a48986b97/1538592068094.png)
- Нажать Credentials и указать там нашего пользователя DHCP.
    
    ![1538592097159](http://gitlabnto/anetto/wiki/uploads/b77fd8ae9ddf942095a67a191059f978/1538592097159.png)
- Нажать ОК, перезапустить службу.

    ![1538592124670](http://gitlabnto/anetto/wiki/uploads/3e18b3dc9fa62b5484dbee5aaaea5a3b/1538592124670.png)

#### Шаг3: Проверка работы DHCP, AD, DNS

##### DHCP

В настройках VMware необходимо создать сеть в которой будет наш контроллер домена и виртуальная машина с ОС Windows 7. **Если на хостовой машине нет прав администратора**, то создать сеть VMWare невозможно. В этом случае изучите, что можно сделать с сетью виртуальных машин, а для работы используйте одну из виртуальных сетей, уже созданных VMWare, например, vmnet5. Создавать эту сеть не нужно, она есть в выборе сетевого адаптера виртуальной машины.

- Для этого в главном окне VMware нажать**Edit** и выбрать**Virtual** **Network** **Editor**.
- В открывшемся окне выбрать **Add** **Network**, выбрать название VMnet2.

    ![1538592298233](http://gitlabnto/anetto/wiki/uploads/5fd0ed1933d135da3cbefede76aa62f8/1538592298233.png)
- Выбирать тип подключения **Host-only**, снять галочки с пунктов **Connect a host virtual adapter to this network** и **Use local DHCP service**. Прописать адрес создаваемой подсети **192.168.0.0**

    ![1538592376712](http://gitlabnto/anetto/wiki/uploads/e9f8b4106a19a8f62f43e41b47e7d082/1538592376712.png)
- Теперь нужно зайти в виртуальную машину с Windows 7 поставить
  автоматическое получение ip адреса.
- Для уверенности, что все заработает перезагрузить обе виртуальные машины. После перезагрузки виртуальная машина с Windows 7 должна автоматически получить ip адрес.

**Active** **Directory**

- Добавить виртуальную машину с Windows 7 в домен.
- В Windows Server открыть оснастку Active Directory и добавить двух пользователей. 
- В Windows 7 попробовать зайти созданным пользователем.

##### DNS

- С Windows Server пропинговать машину с Windows 7 по имени, а не по ip.



