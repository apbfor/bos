## Практическое занятие №2. Смена пароля учётной записи при физическом доступе к ОС Linux

Как объяснялось ранее, [файловые системы](http://gitlabnto/anetto/wiki/wikis/linux-filesystem) Linux и Windows имеют существенные отличия. Отличия касаются также и вопросов хранения различных системных данных, например, учётных записей пользователей. В Windows учётные записи хранятся в реестре или в файлах в бинарном виде. В Linux пошли другим путём - практически все сущности хранятся в текстовом виде. Более того, **все объекты в файловой системе являются файлами** - и флеш-накопители, и принтер, и каталог, и подключение к web-сайту, и ethernet-адаптер - всё это файлы особого вида. Для файла определены такие операции, как "open", "close", "read" и "write".

Как все нормальные инженеры, начнём знакомство с Linux со взлома пароля учётной записи администратора.

### Рассматриваемые вопросы
1. Получение доступа к root через меню восстановления
1. Монтирование разделов файловой системы Linux
1. Изменение пароля учетной записи пользователя
1. Пользователи в Linux

### Термины, которые нужно усвоить
* Всё в файловой системе Linux - файл
* grub
* root
* mount (монтирование)
* less
* ro, rw
* UID пользователя
* команда id
* /etc/passwd
* /etc/shadow
* cat

### Отчёт по пз
1. Скриншот /etc/shadow до смены пароля (шаблон "5-07-1 Иванов shadow 1" для слушателя с фамилией Иванов и 7 по списку в группе 25);
1. Скриншот /etc/shadow после смены пароля (шаблон "5-07-2 Иванов shadow 2");

Скриншоты скопировать в \\\\fs\prepods\ваш\_преподаватель\for_write\BOS\pz2.

### Ход работы
1. Запустить ВМ. Здесь и далее работаем с эталонной виртуальной машиной. Использовать ubuntu 18.04.3 x64 v2. ВМ искать на локальном диске C:\Виртуалки учебные, открываете машину и выполняете manage -> clone -> linked clone. Если на локальной машине нет - в \\\\fs\дистрибутивы архив с этой ВМ тоже есть.

1. Необходимо **уяснить** различие связного (linked) и полного клонов виртуальной машины. Полный клон - это отдельный, независимый каталог с виртуальной машиной, который можно переносить на другой компьютер. Но и места он занимает столько же, сколько и исходный образ ВМ. Связный клон, как следует из названия, связан с клонируемой виртуальной машиной, и без неё функционировать не может. При этом для связного клона на диске сохраняется лишь разница между исходным диском и текущим. Найдите в проводнике вашу склонированную виртуальную машину и запомните её размер. После этого посмотрите на размер исходной виртуальной машины на диске C:.

1. Во время запуска ВМ - [опрос ПЗ1](http://gitlabnto:5000/bos/pz1).

1. Получить root-доступ, то есть доступ к учётной записи администратора системы.
    * зайти в GRUB, зажав shift сразу после запуска виртуальной машины. Выполнить вариант **по указанию преподавателя**;
    * **вариант 1** - чуть более сложный, но работающий даже с root с паролем:
	    * в меню загрузчика GRUB выбрать ОС, для которой нужно сбросить пароль (в нашем случае Ubuntu) и нажать 'e' для редактирования.
	    * найти строку начинающуюся с linux, в ней удалить все после quiet (и только в ней, если после quiet ничего нет - ничего удалять не нужно). После quiet дописать init=/bin/bash (**уяснить** что это означает)
	    * перейти к загрузке, нажав Ctrl+X (все изменения сохраняются до перезагрузки системы)
    * **вариант 2**:
        * Выбрать "дополнительные параметры для Ubuntu";
        * Выбрать "Ubuntu ... (recovery mode)" - загрузку в режиме восстановления;
        * Выбрать root, вторая запись снизу. Квадратики - это некорректно настроенная русская кодировка. [Как исправить?](http://gitlabnto/anetto/wiki/wikis/fix-locale-ubuntu-16.04)
        * ![recovery](/uploads/c46579c720825d119403d48d18968092/recovery.png)
        * После появления надписи "Press Enter for maintenance" нажать enter;
	* Итог: вы имеете перед собой надпись root@an-pc:~ $ (вместо an-pc может быть название вашей машины или none);

1. Перемонтировать файловую систему из режима "только чтение" в режим "чтение и запись"
    * **Обратите внимание на важность соблюдения пробелов в командах ниже**. Внимательно читайте вывод команд - если есть ошибки и о них не написано в описании занятия, то высока вероятность того, что вы делаете что-то неправильно. Попросите помощи преподавателя.
	* Выполнить команду touch, которая создаёт файл, если его не существует;

	```bash
	touch file.txt
	```
	* При успешном завершении команда ничего не выведет. При ошибке будет написано "cannot touch 'file.txt': read-only file system". Проверьте код возврата выполненной команды touch с помощью **echo $?** - 0 соответствует корректному завершению (как в return 0 в Си), а 1 соответствует ошибке.
	* Если команда touch "молча" завершится, то файловая система в состоянии "для чтения и записи" (если вы делали вариант 2 на ubuntu 18.04). У учебных целях перемонтируем систему в режим "только чтение"
    
    ```bash
    mount -n -o remount,ro /
    ```
	* Если команда touch завершится с ошибкой, то файл file.txt не будет создан. Причина тому - файловая система в режиме recovery доступна только для чтения. Воспользуемся командой **mount**, которая отвечает за монтирование, то есть подключение устройств куда-то в дерево файловой системы. Без параметров она выводит все примонтированные разделы. Команда **less** обеспечивает удобное постраничного чтение чего-либо, выход из less осуществляется нажатием **q**. Выполнить

	```bash
    mount | less
    ```
    * (Число после sda зависит от вашего деления диска на разделы) Найти строку /dev/sda2 on / type ext4 (ro,relatime,data=ordered). Это означает, что устройство /dev/sda2 (то есть раздел жёсткого диска, см. такое же обозначение в скриншоте по отчёту ПЗ1, при разбиении жёсткого диска на разделы) подключено в корень / файловой системы. В скобках указаны опции монтирования, ro обозначает read only;
	* Аналогично, нельзя изменить пароль командой passwd - будет ошибка Authentification token manipulation error;
	* Перемонтировать корневую файловую систему на чтение/запись командой 

    ```bash
    mount -n -o remount,rw /
    ```
    * После флага -o указываются опции, с которыми нужно осуществить монтирование. Флаг remount означает "переподключить", флаг rw означает режим "чтение и запись". В конце указывается какую точку файловой системы (в нашем случае корень) нужно использовать.
    * **Уяснить** понятие монтирования;
    * После перемонтирования файловой системы нужно повтороно выполнить mount | less и найти rw в строке /dev/sda2. Это означает успешность перемонтирования из "только для чтения" в "чтение и запись".
    
1. Изменить пароль учетной записи
	* Посмотреть существующих в системе пользователей;
	
	```bash
	cat /etc/passwd
	```
	* Каждая строка содержит имя пользователя, x вместо пароля (значит, пароль нужно искать в /etc/shadow), UID (unique identificator) пользователя, GID (group identificator) группы пользователя, путь к домашней директории пользователя, путь к терминалу по умолчанию (подробнее в ПЗ3). Посмотреть man passwd
	* Посмотреть UID, GID и группы пользователя можно командой **id**. Без параметра даёт информацию по текущему пользователя, для пользователя user нужно выполнить команду id user.
	* Посмотреть хэши паролей всех пользователей. **Сделать скриншот** хэша пароля того пользователя, для которого будет меняться пароль;
	
	```bash
	cat /etc/shadow
	```
	* Каждая строка содержит имя пользователя, xэш его пароля и ряд служебных значений вроде "даты окончания действия пароля".
	* Изменить пароль учётной записи пользователя root командой passwd (passwd без параметров меняет пароль текущего пользователя);
	* Ввести новый пароль;
	* Изменить пароль учётной записи user (для готовой виртуалки пользователя an) командой
	
    ```bash
    passwd user
    ```
	* Ввести новый пароль;
	* Повторно посмотреть /etc/shadow. **Сделать скриншот** хэша нового пароля. **Уяснить**, почему команда passwd не сработала при файловой системе в состоянии read only.
	* Перезагрузиться командой reboot (или reboot -f для варианта 1, когда reboot без параметров жалуется на отсутствие init) и зайти под пользователем user;

1. Порядок сбора всех устройств в единую файловую систему определяется в файле /etc/fstab. Его содержимое можно посмотреть командой

    ```bash
    cat /etc/fstab
    ```	
    * UUID содержим имя диска, вторым идёт точка монтирования, затем тип файловой системы. В конце - опции подключения.

Таким образом, сброс пароля любой учётной записи возможен при физическом доступе к системе. В следующем семестре рассмотрим порядок сброса пароля в ОС Windows. Важно понимать, что этот метод не даст получить доступ к зашифрованным данным пользователя.


### Задание для самостоятельной работы
1. Работа с grub

    ```bash
    cat /etc/default/grub | less
    ```
    * GRUB\_TIMEOUT отвечает за время показа меню grub в секундах, GRUB\_HIDDEN отвечает за пропуск показа этого меню. Если удалить обе строки с HIDDEN, то по умолчанию меню grub будет показываться всегда. Вносить изменения в grub с помощью редактора your_editor (о разных редакторах будет позднее, например, воспользуйтесь редактором nano или vim) можно так:

    ```bash
    your_editor /etc/default/grub
    update-grub
    ```
    * Сделайте так, чтобы меню grub показывалось всегда, и на выбор пункта давалось 33 секунды.
1. Найдите загрузчик первого уровня (сигнатура 55AA) в первых двух байтах (адрес 01f0) с помощью команды:
    
    ```bash
    sudo head /dev/sda | hexdump -C
    
    # или альтернатива
    sudo hd -n 5120 /dev/sda
    ```
    